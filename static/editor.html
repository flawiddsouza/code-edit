<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Code Edit</title>
    <style>
    body {
        margin: 0;
    }

    #editor {
        height: 100dvh;
        width: 100dvw;
    }
    </style>
</head>
<body>
    <div id="editor"></div>
    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.51.0/+esm'

        const editor = monaco.editor.create(document.getElementById('editor'), {
            value: '',
            language: 'plaintext',
            theme: 'vs-dark'
        })

        let originalContent = ''

        let path = window.location.pathname

        fetch(`/file${path}`).then(response => response.json()).then(data => {
            originalContent = data.content
            editor.setValue(data.content)
            document.title = data.name

            const model = monaco.editor.createModel(data.content, undefined, monaco.Uri.file(data.name))
            editor.setModel(model)
        })

        editor.onDidChangeModelContent(() => {
            if (editor.getValue() !== originalContent) {
                document.title = document.title.replace('*', '') + ' *'
            } else {
                document.title = document.title.replace('*', '')
            }
        })

        window.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault() // Prevent the default save dialog

                fetch('/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: path.replace('/', ''),
                        content: editor.getValue()
                    })
                }).then(response => {
                    if (response.ok) {
                        originalContent = editor.getValue() // Update original content to current content
                        document.title = document.title.replace('*', '') // Remove asterisk from title
                        alert('Saved successfully')
                    } else {
                        alert('Save failed')
                    }
                })

                return false
            }
        })
    </script>
</body>
</html>
